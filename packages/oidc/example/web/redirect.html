<!-- Source: https://github.com/openid/AppAuth-JS/blob/master/app/redirect.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Flutter Oidc Redirect</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript">

        // For supported browsers: https://caniuse.com/broadcastchannel
        var bc = new BroadcastChannel('oidc_flutter_web/redirect');
        bc.postMessage(window.location.toString());
        bc.close();
        
        handleRedirect();

        function handleRedirect(params) {
            let dataSrc;
            dataSrc = new URLSearchParams(window.location.search);
            var state = dataSrc.get('state');
            if (!state) {
                if (window.location.hash) {
                    dataSrc = new URLSearchParams(
                        window.location.hash.substring(1)
                    );
                    state = dataSrc.get('state');
                }
            }
            if (!state) {
                return;
            }
            const currentState = localStorage.getItem('oidc-state-' + state);
            if (!currentState) {
                console.error('state not found, key: ' + state);
                return;
            }
            localStorage.setItem('oidc-state-' + state + '-response', window.location.toString());
            const parsedState = JSON.parse(currentState);
            if (!parsedState) {
                console.error('parsed state is null');
                return;
            }
            // Read the mode from the state.
            const webLaunchMode = parsedState.options?.webLaunchMode;
            if (!webLaunchMode) {
                console.error('webLaunchMode not found in parsed state.');
                return;
            }
            if (webLaunchMode != 'samePage') {
                window.close();
                return;
            }
            const original_uri = parsedState.original_uri;
            if (!original_uri) {
                console.warn("it's preferred that original_uri is used when webLaunchMode is samePage.");
                return;
            }
            window.location.assign(original_uri);
        }
    </script>
</head>

<body>
    <h3>Authentication Successful! Please close this page.</h3>
</body>

</html>